
@inherits ComputedStateComponent<ImmutableList<JobSortOrderPair>>

@using System.Numerics
@implements IDisposable

@inject IJobDatabaseService _jobDatabase;
@inject NavigationManager _navigation;

<MudGrid>
    <MudItem lg="12">
        <MudButton Class="ma-3" StartIcon="@Icons.Filled.NewLabel" OnClick="NewJob">Neuer Job</MudButton>
    </MudItem>
    <StateAwaiter State="State">

        @if (context == null || context.Count == 0 || Model == null)
        {
            <MudItem lg="12">
                <MudText>Kein Aktiven Aufträge</MudText>
            </MudItem>
        }
        else
        {
            <MudItem lg="12">
                <JobPriorityControl 
                    ActivePairs="@context.Where(p => p.Info.Status is ProjectStatus.Entered or ProjectStatus.Pending).ToImmutableList()" 
                    Model="Model"/>
            </MudItem>
            <MudItem lg="12">
                <MudList Clickable="true" SelectedValue="_selectedValue" SelectedValueChanged="_newItemSelectedAction">
                    @foreach (var job in context)
                    {
                        <MudListItem @key="job.Info.Project" Value="job">
                            <MudPaper Class="pa-2">
                                <MudGrid>
                                    <MudItem lg="12" Class="mb-n2">
                                        <MudText Typo="Typo.h4">@job.Info.Name.Value</MudText>
                                    </MudItem>
                                    <MudItem lg="8" Class="my-n2">
                                        @if (job.Info.Deadline == null)
                                        {
                                            <MudText Typo="Typo.body1">Kein Termin angegeben</MudText>
                                        }
                                        else
                                        {
                                            <MudText Typo="Typo.body1">Termin: @job.Info.Deadline.Value.LocalDateTime.ToString("d")</MudText>
                                        }
                                    </MudItem>
                                    <MudItem lg="2" Style="height: 48px" Class="my-n2">
                                        @if (job.Order.IsPriority)
                                        {
                                            <MudTooltip Text="Dieser Job hat Priorität">
                                                <MudIcon Icon="@Icons.Rounded.Warning" Color="Color.Warning"/>
                                            </MudTooltip>
                                        }
                                    </MudItem>
                                    <MudItem lg="2" Style="height: 48px" Class="my-n2">
                                        @if (!job.Info.FilesPresent)
                                        {
                                            <MudTooltip Text="Für diesen Job wurden keine Daten Hochgeladen">
                                                <MudIcon Icon="@Icons.Rounded.FileUpload" Color="Color.Warning" />
                                            </MudTooltip>
                                        }
                                    </MudItem>
                                    <MudItem lg="12" Class="mt-n2">
                                        <MudText Typo="Typo.body1">Status: @JobTranslator.GetString(job.Info.Status)</MudText>
                                    </MudItem>
                                </MudGrid>
                            </MudPaper>
                        </MudListItem>
                    }
                </MudList>
            </MudItem>
        }
    </StateAwaiter>
</MudGrid>

@code {
    
    [Parameter]
    public JobInfo[]? CurrentJobs { get; set; } = Array.Empty<JobInfo>();

    [Parameter]
    public JobsViewModel? Model { get; set; }
    
    private object? _selectedValue;
    private IDisposable _subscription = System.Reactive.Disposables.Disposable.Empty;

    private void NewJob()
        => _navigation.NavigateTo("/NewJob");

    protected override void OnInitialized()
    {
        _newItemSelectedAction = EventUtil.AsNonRenderingEventHandler<object?>(NewItemSelected);

        base.OnInitialized();
    }

    protected override void OnParametersSet()
    {
        if (Model != null)
        {
            _subscription.Dispose();
            _subscription = Model
                .CurrentInfo
                .Subscribe(i =>
                           {
                               if (_selectedValue is not JobSortOrderPair info || info != i) return;

                               _selectedValue = i;
                               StateHasChanged();

                           });
        }

        base.OnParametersSet();
    }

    private Action<object?> _newItemSelectedAction = _ => { };

    private void NewItemSelected(object? data)
    {
        _selectedValue = data;

        if(data is JobSortOrderPair info)
        Model?.Publish(info);
    }

    protected override async Task<ImmutableList<JobSortOrderPair>> ComputeState(CancellationToken cancellationToken)
    {
        try
        {
            var list = new List<JobSortOrderPair>();

    // ReSharper disable once InvertIf
            if (CurrentJobs != null)
            {
                var activeJobs = CurrentJobs.ToDictionary(c => c.Project);
                foreach (var sortOrder in await _jobDatabase.GetSortOrders(cancellationToken))
                {
                    if (activeJobs.Remove(sortOrder.Id, out var data))
                        list.Add(new JobSortOrderPair(sortOrder, data));
                }

                list.AddRange(activeJobs.Select(job => new JobSortOrderPair(new SortOrder(job.Key, 0, false), job.Value)));
            }

            return list
                //.OrderByDescending(j => j, JobSortOrderPairComparer.Comp)
                .GroupBy(p => p.Info.Status)
                .OrderByDescending(g => g.Key)
                .SelectMany(StatusToPrioritySort)
                .ToImmutableList();
        }
        catch (Exception e)
        {
            Console.WriteLine(e);
            throw;
        }
    }

    private IEnumerable<JobSortOrderPair> StatusToPrioritySort(IGrouping<ProjectStatus, JobSortOrderPair> statusGroup)
    {
        if (statusGroup.Key is ProjectStatus.Entered or ProjectStatus.Pending)
        {
            return statusGroup.GroupBy(s => s.Order.IsPriority)
                .OrderByDescending(g1 => g1.Key)
                .SelectMany(PriorityToSkipCountSort);
        }

        return statusGroup.OrderBy(p => p.Info.Deadline?.Value ?? DateTimeOffset.MaxValue);
    }

    private IEnumerable<JobSortOrderPair> PriorityToSkipCountSort(IGrouping<bool, JobSortOrderPair> priorityGroup)
    {
        var temp = priorityGroup.OrderBy(p => p.Info.Deadline?.Value ?? DateTimeOffset.MaxValue).ToArray();
        for (var index = 0; index < temp.ToArray().Length; index++)
        {
            var orderPair = temp.ToArray()[index];

            if (orderPair.Order.SkipCount == 0)
                continue;

            SwapArray(orderPair, index, temp);
        }

        return temp;
    }

    private static void SwapArray(JobSortOrderPair orderPair, int index, JobSortOrderPair[] temp)
    {
        for (var i = 0; i < orderPair.Order.SkipCount; i++)
        {
            if (index - i + 1 >= temp.Length) break;

            temp[index - i] = temp[index - i + 1];
        }

        if (index - orderPair.Order.SkipCount >= temp.Length)
            temp[^1] = orderPair;
        else
            temp[index - orderPair.Order.SkipCount] = orderPair;
    }

    public void Dispose()
        => _subscription.Dispose();

}
